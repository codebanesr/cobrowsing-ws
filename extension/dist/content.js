(()=>{class e{constructor(){this.isController=!1,this.isActive=!1,this.lastScrollTime=0,this.scrollThrottle=100,this.remoteCursor=null,this.setupMessageListener(),this.injectScript(),this.createRemoteCursor(),this.requestCurrentState()}setupMessageListener(){chrome.runtime.onMessage.addListener((e,t,s)=>(this.handleMessage(e,t,s),!0))}injectScript(){const e=document.createElement("script");e.src=chrome.runtime.getURL("injected.js"),e.onload=()=>e.remove(),(document.head||document.documentElement).appendChild(e),window.addEventListener("cobrowsing-event",e=>{this.isController&&this.isActive&&this.sendEventToBackground(e.detail.type,e.detail.data)})}handleMessage(e,t,s){switch(e.type){case"apply-sync-event":this.isController||this.applySyncEvent(e.eventType,e.data),s({success:!0});break;case"set-controller":this.isController=e.isController,this.isActive=e.isActive,window.postMessage({type:"cobrowsing-control-change",isController:this.isController},"*"),s({success:!0})}}applySyncEvent(e,t){switch(e){case"scroll":this.applyScroll(t);break;case"click":this.applyClick(t);break;case"input":this.applyInput(t);break;case"navigation":this.applyNavigation(t);break;case"form-submit":this.applyFormSubmit(t);break;case"cursor-move":this.applyCursorMove(t);break;case"focus":this.applyFocus(t);break;case"selection-change":this.applySelectionChange(t)}}applyScroll(e){this.isActive=!1,window.scrollTo({left:e.x,top:e.y,behavior:"smooth"}),setTimeout(()=>{this.isActive=!0},200)}applyClick(e){const t=this.findElementBySelector(e.selector);if(t){const s=new MouseEvent("click",{view:window,bubbles:!0,cancelable:!0,clientX:e.x,clientY:e.y});t.dispatchEvent(s)}}applyInput(e){const t=this.findElementBySelector(e.selector);if(t&&("INPUT"===t.tagName||"TEXTAREA"===t.tagName)){t.value=e.value,"number"==typeof e.selectionStart&&"number"==typeof e.selectionEnd&&t.setSelectionRange(e.selectionStart,e.selectionEnd);const s=new Event("input",{bubbles:!0});t.dispatchEvent(s);const o=new Event("change",{bubbles:!0});t.dispatchEvent(o)}}applyNavigation(e){e.url&&e.url!==window.location.href&&(window.location.href=e.url)}applyFormSubmit(e){const t=this.findElementBySelector(e.formSelector);t&&"FORM"===t.tagName&&t.submit()}findElementBySelector(e){try{return document.querySelector(e)}catch(t){return console.warn("Invalid selector:",e),null}}generateSelector(e){if(!e)return"";if(e.id)return`#${e.id}`;if(e.className&&"string"==typeof e.className){const t=e.className.trim().split(/\s+/).slice(0,3);if(t.length>0)return`${e.tagName.toLowerCase()}.${t.join(".")}`}const t=e.parentElement;if(t){const s=Array.from(t.children).filter(t=>t.tagName===e.tagName).indexOf(e)+1;return`${this.generateSelector(t)} > ${e.tagName.toLowerCase()}:nth-child(${s})`}return e.tagName.toLowerCase()}applyCursorMove(e){this.remoteCursor&&(this.remoteCursor.style.left=`${e.pageX}px`,this.remoteCursor.style.top=`${e.pageY}px`,this.remoteCursor.style.display="block",clearTimeout(this.remoteCursor._hideTimeout),this.remoteCursor._hideTimeout=setTimeout(()=>{this.remoteCursor&&(this.remoteCursor.style.display="none")},3e3))}applyFocus(e){const t=this.findElementBySelector(e.selector);!t||"INPUT"!==t.tagName&&"TEXTAREA"!==t.tagName&&"true"!==t.contentEditable||t.focus()}applySelectionChange(e){const t=this.findElementBySelector(e.selector);!t||"INPUT"!==t.tagName&&"TEXTAREA"!==t.tagName||"number"==typeof e.selectionStart&&"number"==typeof e.selectionEnd&&t.setSelectionRange(e.selectionStart,e.selectionEnd)}createRemoteCursor(){this.remoteCursor&&this.remoteCursor.remove();const e=()=>{this.remoteCursor=document.createElement("div"),this.remoteCursor.id="cobrowsing-remote-cursor",this.remoteCursor.style.cssText="\n        position: absolute;\n        width: 24px;\n        height: 24px;\n        pointer-events: none;\n        z-index: 999999;\n        display: none;\n        transition: all 0.08s ease;\n        filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.3));\n      ",this.remoteCursor.innerHTML='\n        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n          <path d="M3 3L20 10L12 12L10 20L3 3Z" fill="#FF4444" stroke="#FFFFFF" stroke-width="2"/>\n          <path d="M3 3L20 10L12 12L10 20L3 3Z" fill="none" stroke="#000000" stroke-width="1"/>\n          <circle cx="18" cy="6" r="4" fill="#FF4444" stroke="#FFFFFF" stroke-width="2"/>\n          <circle cx="18" cy="6" r="4" fill="none" stroke="#000000" stroke-width="1"/>\n          <text x="18" y="8" text-anchor="middle" fill="#FFFFFF" font-family="Arial" font-size="8" font-weight="bold">‚óè</text>\n        </svg>\n      ',document.body?document.body.appendChild(this.remoteCursor):setTimeout(e,100)};e()}sendEventToBackground(e,t){chrome.runtime.sendMessage({type:"sync-event",eventType:e,data:t})}async requestCurrentState(){try{const e=await chrome.runtime.sendMessage({type:"get-status"});e&&e.roomId&&(this.isActive=!0,this.isController=e.isController,window.postMessage({type:"cobrowsing-control-change",isController:this.isController},"*"))}catch(e){console.log("Could not get current state:",e.message)}}}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{new e}):new e})();